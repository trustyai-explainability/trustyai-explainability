package org.kie.trustyai.metrics.drift.meanshift;

import java.util.List;
import java.util.Map;
import java.util.Random;

import org.junit.jupiter.api.Test;
import org.kie.trustyai.explainability.model.dataframe.Dataframe;
import org.kie.trustyai.metrics.utils.PerColumnStatistics;
import org.kie.trustyai.metrics.utils.PregeneratedNormalData;

import static org.junit.jupiter.api.Assertions.*;

class MeanshiftTest {
    // lists of reference columns (drawn from 5 random normal distributions)
    // shape = 25 x 100
    double[][] cols = PregeneratedNormalData.getData();
    int nReferenceCols = cols.length;

    // tables of expected results for col_i against col_j (computed via https://github.ibm.com/Dublin-Research-Lab/mat-base/blob/master/demo/metrics/meanshift_test.py)
    double[][] tstatTable = {
            { 0.0, 1.0672762676396055, -2.4364107583330115, -1.8832626116127404, 1.0506475702755214, 4.937395246516001, 0.8365704090933118, -0.16865647544498, 5.458635252531385, -1.7023041209440966,
                    4.287587111889207, -2.827870835300019, 0.513290783358859, -3.062728232765329, -0.12725973351412462, -0.8959098158332477, 4.5743379690867085, 0.10957762135937045,
                    -3.1119293708906817, 0.4623669163101819, -3.847488901952086, 1.9872843449972717, 1.2649831272686793, 1.241905254598443, -2.2205956182513735 },
            { -1.0672762676396055, 0.0, -3.680624924008994, -3.161915414245844, 0.22364367147605083, 3.751362942724765, -0.0336269860138488, -1.2438704553763082, 4.244389652240965,
                    -2.5715408552902095, 3.086534149295548, -4.123963831374583, -0.3111313017615634, -4.41185386402613, -1.086358560506406, -1.804400586328332, 3.3794224706993727, -0.6787096862631289,
                    -4.385723715300988, -0.36745013438992363, -5.13258862065952, 0.9641392777825224, 0.37105179122236903, 0.17602352459404313, -3.4682700266542907 },
            { 2.4364107583330115, 3.680624924008994, 0.0, 0.7471606957753364, 2.954008747158361, 8.963866419058409, 2.836589726385982, 2.2626274869881677, 9.835522162219911, 0.046336993967459404,
                    8.204034015495086, -0.364648762837253, 2.36035291294186, -0.5461282614069768, 1.9998624182926643, 1.0190887006707061, 8.542430035477471, 1.8313789714383482, -0.7515728624646947,
                    2.318695735343612, -1.6139167572556208, 4.60724240376844, 3.3782029780946603, 3.8807398930698636, 0.26686415827163223 },
            { 1.8832626116127404, 3.161915414245844, -0.7471606957753364, 0.0, 2.5390375288503186, 8.63845539428694, 2.397756603495705, 1.7002979013802515, 9.572952772214794, -0.43460080744100854,
                    7.836911218753712, -1.168389876525536, 1.938252680659048, -1.4048746021635854, 1.4979021733132032, 0.5289564224641635, 8.19402211902889, 1.4217726514539801, -1.5496079870977542,
                    1.8931384500093866, -2.4516855232020305, 4.134083585631304, 2.9366829511333234, 3.368465276041657, -0.47381376142504056 },
            { -1.0506475702755214, -0.22364367147605083, -2.954008747158361, -2.5390375288503186, 0.0, 2.4418963805920795, -0.22338688911787913, -1.1864650241554748, 2.738200480826251,
                    -2.3483059202436958, 1.9629142310541159, -3.2377062515408306, -0.45090141636818387, -3.39733705948694, -1.0854973380580493, -1.68807702604717, 2.173207866882841,
                    -0.7631401337621757, -3.455841810463986, -0.49883317159491847, -4.005435344920185, 0.5343777346816817, 0.10585396353509212, -0.08787455481633125, -2.7915065706044238 },
            { -4.937395246516001, -3.751362942724765, -8.963866419058409, -8.63845539428694, -2.4418963805920795, 0.0, -2.8909971518549504, -5.17551047637298, 0.4758133516618378, -5.599259623773654,
                    -0.871946292567152, -9.861649383148395, -3.0012654063293196, -10.633932321017808, -4.4185795202371025, -4.958485551462412, -0.4898449135890238, -3.247115399239452,
                    -9.978581200433213, -3.0829526710150965, -10.903028436118749, -2.4653239066815056, -2.5535588194554126, -3.547935462509953, -8.750950351098394 },
            { -0.8365704090933118, 0.0336269860138488, -2.836589726385982, -2.397756603495705, 0.22338688911787913, 2.8909971518549504, 0.0, -0.9785861731983444, 3.218365295792621, -2.206445673705979,
                    2.383097324243634, -3.138214962645348, -0.24461339627314205, -3.3095907545283265, -0.884960788850389, -1.5181125689667814, 2.606251254220393, -0.5740313617855674,
                    -3.3681040856609683, -0.2933369390415972, -3.949683988499305, 0.8233148711884307, 0.3473968242549808, 0.17640739805382244, -2.664834746042749 },
            { 0.16865647544498, 1.2438704553763082, -2.2626274869881677, -1.7002979013802515, 1.1864650241554748, 5.17551047637298, 0.9785861731983444, 0.0, 5.71047832195859, -1.5725310201121645,
                    4.521493092223077, -2.6514526645906766, 0.6462585437967417, -2.882579949885111, 0.023793995779045157, -0.7566651859371121, 4.810226361475347, 0.23504679006508147,
                    -2.9405299076363103, 0.5959818276679922, -3.681169355993277, 2.162983287393847, 1.413234439651805, 1.4195990034270722, -2.0445281077922433 },
            { -5.458635252531385, -4.244389652240965, -9.835522162219911, -9.572952772214794, -2.738200480826251, -0.4758133516618378, -3.218365295792621, -5.71047832195859, 0.0, -5.965001997902728,
                    -1.4043846797439887, -10.865140157449018, -3.303792189219129, -11.791797244658332, -4.8323923615922935, -5.3430976071301695, -0.9978128923388084, -3.532980936679062,
                    -10.934510502665026, -3.3896161478842153, -11.904139685937364, -2.888563374401368, -2.8897991459908474, -4.034567893201614, -9.624260654931957 },
            { 1.7023041209440966, 2.5715408552902095, -0.046336993967459404, 0.43460080744100854, 2.3483059202436958, 5.599259623773654, 2.206445673705979, 1.5725310201121645, 5.965001997902728, 0.0,
                    5.110984415836337, -0.2823632616285389, 1.8756115360155012, -0.390412755314782, 1.4797291263363765, 0.7590805243120635, 5.326149753076169, 1.4755914361405555, -0.5389819211010917,
                    1.8372899934277052, -1.104698294233646, 3.2918918698692883, 2.5969634816944667, 2.712064269703533, 0.12938356796602282 },
            { -4.287587111889207, -3.086534149295548, -8.204034015495086, -7.836911218753712, -1.9629142310541159, 0.871946292567152, -2.383097324243634, -4.521493092223077, 1.4043846797439887,
                    -5.110984415836337, 0.0, -9.06403337212659, -2.5277785884601127, -9.793276773018073, -3.8545073534976124, -4.43758268038222, 0.3827647891106965, -2.8004976434756124,
                    -9.20602851959541, -2.6061156471943416, -10.134755741037285, -1.825633167975113, -2.024811804662633, -2.881757080971124, -7.984058639017171 },
            { 2.827870835300019, 4.123963831374583, 0.364648762837253, 1.168389876525536, 3.2377062515408306, 9.861649383148395, 3.138214962645348, 2.6514526645906766, 10.865140157449018,
                    0.2823632616285389, 9.06403337212659, 0.0, 2.629942610207876, -0.17287817083238907, 2.320832752620339, 1.29160370080631, 9.420262581909716, 2.0753761040104095, -0.4157923363366279,
                    2.5897315730457655, -1.3199878692084621, 5.057908133986295, 3.7060167356937135, 4.331784194926644, 0.6469836071705186 },
            { -0.513290783358859, 0.3111313017615634, -2.36035291294186, -1.938252680659048, 0.45090141636818387, 3.0012654063293196, 0.24461339627314205, -0.6462585437967417, 3.303792189219129,
                    -1.8756115360155012, 2.5277785884601127, -2.629942610207876, 0.0, -2.7763304034322647, -0.5832558947356611, -1.2022563702390223, 2.7357792050949716, -0.32610864626717706,
                    -2.8527689580452367, -0.04570019208790191, -3.397428300056941, 1.0531519593120247, 0.5818322689025421, 0.44605218656181583, -2.1975637845585387 },
            { 3.062728232765329, 4.41185386402613, 0.5461282614069768, 1.4048746021635854, 3.39733705948694, 10.633932321017808, 3.3095907545283265, 2.882579949885111, 11.791797244658332,
                    0.390412755314782, 9.793276773018073, 0.17287817083238907, 2.7763304034322647, 0.0, 2.4994164468197426, 1.4295629300740555, 10.169838967831584, 2.2019905957559596,
                    -0.26980781330087367, 2.7368037599210866, -1.2202750266555644, 5.358481736640865, 3.8998605735408263, 4.62775317926946, 0.8442841381757844 },
            { 0.12725973351412462, 1.086358560506406, -1.9998624182926643, -1.4979021733132032, 1.0854973380580493, 4.4185795202371025, 0.884960788850389, -0.023793995779045157, 4.8323923615922935,
                    -1.4797291263363765, 3.8545073534976124, -2.320832752620339, 0.5832558947356611, -2.4994164468197426, 0.0, -0.7179700615632923, 4.102960697633316, 0.20203188900357125,
                    -2.5832085015300676, 0.5358471467684961, -3.228090980969453, 1.9190991827753285, 1.280357304295228, 1.2429556207920929, -1.8073723757781983 },
            { 0.8959098158332477, 1.804400586328332, -1.0190887006707061, -0.5289564224641635, 1.68807702604717, 4.958485551462412, 1.5181125689667814, 0.7566651859371121, 5.3430976071301695,
                    -0.7590805243120635, 4.43758268038222, -1.29160370080631, 1.2022563702390223, -1.4295629300740555, 0.7179700615632923, 0.0, 4.6670547031690335, 0.8123221608547724,
                    -1.5509031539436366, 1.159623860392167, -2.15087002374623, 2.575144183646486, 1.9098310575266777, 1.9519680635884125, -0.836086754399737 },
            { -4.5743379690867085, -3.3794224706993727, -8.542430035477471, -8.19402211902889, -2.173207866882841, 0.4898449135890238, -2.606251254220393, -4.810226361475347, 0.9978128923388084,
                    -5.326149753076169, -0.3827647891106965, -9.420262581909716, -2.7357792050949716, -10.169838967831584, -4.102960697633316, -4.6670547031690335, 0.0, -2.996700838407445,
                    -9.55090215503318, -2.8156128752736835, -10.478319433443039, -2.1068264158795857, -2.257069004881763, -3.175150122410766, -8.325516256680547 },
            { -0.10957762135937045, 0.6787096862631289, -1.8313789714383482, -1.4217726514539801, 0.7631401337621757, 3.247115399239452, 0.5740313617855674, -0.23504679006508147, 3.532980936679062,
                    -1.4755914361405555, 2.8004976434756124, -2.0753761040104095, 0.32610864626717706, -2.2019905957559596, -0.20203188900357125, -0.8123221608547724, 2.996700838407445, 0.0,
                    -2.2929065485653415, 0.2832956071983129, -2.808625534566329, 1.380705232899937, 0.9046368513074614, 0.8073743432893147, -1.6755348819646767 },
            { 3.1119293708906817, 4.385723715300988, 0.7515728624646947, 1.5496079870977542, 3.455841810463986, 9.978581200433213, 3.3681040856609683, 2.9405299076363103, 10.934510502665026,
                    0.5389819211010917, 9.20602851959541, 0.4157923363366279, 2.8527689580452367, 0.26980781330087367, 2.5832085015300676, 1.5509031539436366, 9.55090215503318, 2.2929065485653415,
                    0.0, 2.814340722462289, -0.8797478014492714, 5.295282520926716, 3.9356582507969944, 4.58953972997576, 1.0290765115747231 },
            { -0.4623669163101819, 0.36745013438992363, -2.318695735343612, -1.8931384500093866, 0.49883317159491847, 3.0829526710150965, 0.2933369390415972, -0.5959818276679922, 3.3896161478842153,
                    -1.8372899934277052, 2.6061156471943416, -2.5897315730457655, 0.04570019208790191, -2.7368037599210866, -0.5358471467684961, -1.159623860392167, 2.8156128752736835,
                    -0.2832956071983129, -2.814340722462289, 0.0, -3.3627877895413008, 1.1127329146966327, 0.6332853153330308, 0.503223966962562, -2.1547094221068708 },
            { 3.847488901952086, 5.13258862065952, 1.6139167572556208, 2.4516855232020305, 4.005435344920185, 10.903028436118749, 3.949683988499305, 3.681169355993277, 11.904139685937364,
                    1.104698294233646, 10.134755741037285, 1.3199878692084621, 3.397428300056941, 1.2202750266555644, 3.228090980969453, 2.15087002374623, 10.478319433443039, 2.808625534566329,
                    0.8797478014492714, 3.3627877895413008, 0.0, 6.012769261799621, 4.538734204044188, 5.33707923102086, 1.8975135866290356 },
            { -1.9872843449972717, -0.9641392777825224, -4.60724240376844, -4.134083585631304, -0.5343777346816817, 2.4653239066815056, -0.8233148711884307, -2.162983287393847, 2.888563374401368,
                    -3.2918918698692883, 1.825633167975113, -5.057908133986295, -1.0531519593120247, -5.358481736640865, -1.9190991827753285, -2.575144183646486, 2.1068264158795857,
                    -1.380705232899937, -5.295282520926716, -1.1127329146966327, -6.012769261799621, 0.0, -0.4518647754278179, -0.7943841200139904, -4.406957238806471 },
            { -1.2649831272686793, -0.37105179122236903, -3.3782029780946603, -2.9366829511333234, -0.10585396353509212, 2.5535588194554126, -0.3473968242549808, -1.413234439651805,
                    2.8897991459908474, -2.5969634816944667, 2.024811804662633, -3.7060167356937135, -0.5818322689025421, -3.8998605735408263, -1.280357304295228, -1.9098310575266777,
                    2.257069004881763, -0.9046368513074614, -3.9356582507969944, -0.6332853153330308, -4.538734204044188, 0.4518647754278179, 0.0, -0.22392215847821853, -3.2023535093816977 },
            { -1.241905254598443, -0.17602352459404313, -3.8807398930698636, -3.368465276041657, 0.08787455481633125, 3.547935462509953, -0.17640739805382244, -1.4195990034270722, 4.034567893201614,
                    -2.712064269703533, 2.881757080971124, -4.331784194926644, -0.44605218656181583, -4.62775317926946, -1.2429556207920929, -1.9519680635884125, 3.175150122410766,
                    -0.8073743432893147, -4.58953972997576, -0.503223966962562, -5.33707923102086, 0.7943841200139904, 0.22392215847821853, 0.0, -3.6692725364865564 },
            { 2.2205956182513735, 3.4682700266542907, -0.26686415827163223, 0.47381376142504056, 2.7915065706044238, 8.750950351098394, 2.664834746042749, 2.0445281077922433, 9.624260654931957,
                    -0.12938356796602282, 7.984058639017171, -0.6469836071705186, 2.1975637845585387, -0.8442841381757844, 1.8073723757781983, 0.836086754399737, 8.325516256680547, 1.6755348819646767,
                    -1.0290765115747231, 2.1547094221068708, -1.8975135866290356, 4.406957238806471, 3.2023535093816977, 3.6692725364865564, 0.0 },
    };
    double[][] pvalTable = {
            { 1.0, 0.2871466720343605, 0.015718099381728523, 0.06113087297703279, 0.2947011110109039, 1.6778525742111583e-06, 0.403842589149187, 0.8662390191597573, 1.4256287239611254e-07,
                    0.09026777952628029, 2.8200990389803948e-05, 0.005167467192306763, 0.6083201806337459, 0.0024982708497784945, 0.8988639769831892, 0.37138883614876494, 8.414158198633004e-06,
                    0.9128553367958441, 0.0021335019339503436, 0.6443259005749744, 0.00016090191189466196, 0.04826936192406017, 0.20736414310740714, 0.21574056209118986, 0.027512080784199977 },
            { 0.2871466720343605, 1.0, 0.00029993390435434364, 0.0018138421341491462, 0.823265158725544, 0.0002309304810679258, 0.9732084771281775, 0.21501784174627203, 3.36668480651614e-05,
                    0.010857865832990088, 0.0023151419626836756, 5.477883984772447e-05, 0.7560281235243345, 1.6815893463251186e-05, 0.2786411720003672, 0.07268817077750378, 0.000874804335955881,
                    0.498114343928149, 1.876419933255491e-05, 0.7136757365000084, 6.801079066587334e-07, 0.3361521538090364, 0.7109956591278599, 0.860455359505405, 0.0006425929757265525 },
            { 0.015718099381728523, 0.00029993390435434364, 1.0, 0.45585291621981705, 0.0035167203375388034, 2.220446049250313e-16, 0.005033886311318847, 0.02474423412354443, 0.0, 0.9630883556233276,
                    2.90878432451791e-14, 0.7157627689777786, 0.01922976208886973, 0.5855925950916516, 0.04688187135152799, 0.3094044390453097, 3.552713678800501e-15, 0.06854670075541414,
                    0.4532003763388206, 0.02143217336202774, 0.10813801824129099, 7.2970293003571385e-06, 0.0008784788425570955, 0.00014176902571128025, 0.7898514863190971 },
            { 0.06113087297703279, 0.0018138421341491462, 0.45585291621981705, 1.0, 0.011884435452515607, 1.7763568394002505e-15, 0.017424643055497624, 0.0906450494376132, 0.0, 0.6643254754710419,
                    2.7755575615628914e-13, 0.2440543989450732, 0.054014344441254636, 0.16162547277376715, 0.13575118536812036, 0.5974281528313417, 3.086420008457935e-14, 0.15666550320939443,
                    0.12283251689947461, 0.05979800460727058, 0.015085669860296136, 5.260447462585027e-05, 0.0037104279017825537, 0.0009083413431145715, 0.6361547542313641 },
            { 0.2947011110109039, 0.823265158725544, 0.0035167203375388034, 0.011884435452515607, 1.0, 0.015488320674504008, 0.8234647102282251, 0.23686039120680702, 0.006740818465288401,
                    0.019845232916282818, 0.051056668908659564, 0.0014127959269463197, 0.6525540029458028, 0.0008224533945448975, 0.2790212813366655, 0.09297087274542304, 0.030951727865833556,
                    0.4462881127402396, 0.0006711761536843941, 0.618450650260904, 8.754340507421965e-05, 0.5936797284449291, 0.915805384818495, 0.9300651912071818, 0.00576010207415778 },
            { 1.6778525742111583e-06, 0.0002309304810679258, 2.220446049250313e-16, 1.7763568394002505e-15, 0.015488320674504008, 1.0, 0.004268992947684458, 5.557875797368439e-07, 0.634731907854341,
                    7.121285938715971e-08, 0.38429376106252455, 0.0, 0.003034547661584952, 0.0, 1.6346763008323606e-05, 1.5237001735890487e-06, 0.6247859404499154, 0.0013692098237374495, 0.0,
                    0.002341877191370134, 0.0, 0.014540182902510468, 0.01141553889749014, 0.00048479010798008204, 8.881784197001252e-16 },
            { 0.403842589149187, 0.9732084771281775, 0.005033886311318847, 0.017424643055497624, 0.8234647102282251, 0.004268992947684458, 1.0, 0.32897863797411375, 0.0015064659291532667,
                    0.02850257603902051, 0.018113455927128763, 0.001959433260175558, 0.807009100308395, 0.0011100438870954576, 0.3772511919703043, 0.13058108629632548, 0.009849942090619956,
                    0.5665980938774062, 0.000909467025424604, 0.7695718424282729, 0.00010875399829579635, 0.4113194879928441, 0.7286622086504158, 0.8601541952387919, 0.008337911654616281 },
            { 0.8662390191597573, 0.21501784174627203, 0.02474423412354443, 0.0906450494376132, 0.23686039120680702, 5.557875797368439e-07, 0.32897863797411375, 1.0, 4.078575899235659e-08,
                    0.11742401761430665, 1.0560546098492551e-05, 0.008663567278827555, 0.5188602807699843, 0.004379924470195196, 0.9810408916987221, 0.4501498762213487, 2.9813718351867635e-06,
                    0.8144153236957845, 0.0036665924441832143, 0.5518680514542944, 0.0002993353151485856, 0.03174085377113545, 0.15915693492736138, 0.15729692377242777, 0.0422248681648516 },
            { 1.4256287239611254e-07, 3.36668480651614e-05, 0.0, 0.0, 0.006740818465288401, 0.634731907854341, 0.0015064659291532667, 4.078575899235659e-08, 1.0, 1.1087010420851584e-08,
                    0.16177103822539163, 0.0, 0.0011320201462983182, 0.0, 2.699201128386619e-06, 2.4989657698704093e-07, 0.3195879573106324, 0.0005113151690325779, 0.0, 0.0008446461634001867, 0.0,
                    0.004300801276611255, 0.004284623361268336, 7.808955319377198e-05, 0.0 },
            { 0.09026777952628029, 0.010857865832990088, 0.9630883556233276, 0.6643254754710419, 0.019845232916282818, 7.121285938715971e-08, 0.02850257603902051, 0.11742401761430665,
                    1.1087010420851584e-08, 1.0, 7.525082401649286e-07, 0.7779599210424029, 0.062180446736953776, 0.6966510587273933, 0.14053485344441596, 0.44870710302820305, 2.711530253662886e-07,
                    0.1416420561555476, 0.5905048269806548, 0.06766589101132836, 0.27063095810327553, 0.0011783967730545353, 0.01011106459969957, 0.007274902568656039, 0.8971854870523459 },
            { 2.8200990389803948e-05, 0.0023151419626836756, 2.90878432451791e-14, 2.7755575615628914e-13, 0.051056668908659564, 0.38429376106252455, 0.018113455927128763, 1.0560546098492551e-05,
                    0.16177103822539163, 7.525082401649286e-07, 1.0, 0.0, 0.012259754444186699, 0.0, 0.00015667011977615886, 1.5088193166867825e-05, 0.7023047530606426, 0.005608088104749331, 0.0,
                    0.009853710668938476, 0.0, 0.06941197103759311, 0.044229573135349476, 0.004390909251123176, 1.1302070390684094e-13 },
            { 0.005167467192306763, 5.477883984772447e-05, 0.7157627689777786, 0.2440543989450732, 0.0014127959269463197, 0.0, 0.001959433260175558, 0.008663567278827555, 0.0, 0.7779599210424029, 0.0,
                    1.0, 0.009211074441921152, 0.862923783202203, 0.021314021973458663, 0.19800011270837214, 0.0, 0.03924387870785795, 0.6780122519144749, 0.010318669887999565, 0.18836308423586168,
                    9.635875533042793e-07, 0.00027318535576537073, 2.3493472470326182e-05, 0.5183918860527874 },
            { 0.6083201806337459, 0.7560281235243345, 0.01922976208886973, 0.054014344441254636, 0.6525540029458028, 0.003034547661584952, 0.807009100308395, 0.5188602807699843, 0.0011320201462983182,
                    0.062180446736953776, 0.012259754444186699, 0.009211074441921152, 1.0, 0.006025202125593099, 0.5603847911586044, 0.23070005357150802, 0.006788760342852251, 0.7446865656533612,
                    0.004794310652375344, 0.9635952691337171, 0.0008221944241708634, 0.29355485837660256, 0.5613415185367734, 0.6560469395135131, 0.02913999571445358 },
            { 0.0024982708497784945, 1.6815893463251186e-05, 0.5855925950916516, 0.16162547277376715, 0.0008224533945448975, 0.0, 0.0011100438870954576, 0.004379924470195196, 0.0, 0.6966510587273933,
                    0.0, 0.862923783202203, 0.006025202125593099, 1.0, 0.013252516249647739, 0.15441841517845378, 0.0, 0.0288207714318085, 0.7875890995355441, 0.006768436339636086,
                    0.22381198228808596, 2.3201192633770518e-07, 0.00013176608043852234, 6.6745135760548635e-06, 0.39952957926571564 },
            { 0.8988639769831892, 0.2786411720003672, 0.04688187135152799, 0.13575118536812036, 0.2790212813366655, 1.6346763008323606e-05, 0.3772511919703043, 0.9810408916987221,
                    2.699201128386619e-06, 0.14053485344441596, 0.00015667011977615886, 0.021314021973458663, 0.5603847911586044, 0.013252516249647739, 1.0, 0.4736220215739593, 5.9568581225244444e-05,
                    0.8400992196691042, 0.010509196933885523, 0.5926656132168697, 0.0014586656940163145, 0.05640968517976419, 0.2019174007758664, 0.21535406142524272, 0.0722220856911091 },
            { 0.37138883614876494, 0.07268817077750378, 0.3094044390453097, 0.5974281528313417, 0.09297087274542304, 1.5237001735890487e-06, 0.13058108629632548, 0.4501498762213487,
                    2.4989657698704093e-07, 0.44870710302820305, 1.5088193166867825e-05, 0.19800011270837214, 0.23070005357150802, 0.15441841517845378, 0.4736220215739593, 1.0, 5.621661298471636e-06,
                    0.4175823709772777, 0.12252179552985676, 0.24759845267889768, 0.032698188561780306, 0.010749096237534062, 0.057600374448060876, 0.05235214588576542, 0.40411394948128887 },
            { 8.414158198633004e-06, 0.000874804335955881, 3.552713678800501e-15, 3.086420008457935e-14, 0.030951727865833556, 0.6247859404499154, 0.009849942090619956, 2.9813718351867635e-06,
                    0.3195879573106324, 2.711530253662886e-07, 0.7023047530606426, 0.0, 0.006788760342852251, 0.0, 5.9568581225244444e-05, 5.621661298471636e-06, 1.0, 0.003078320501143761, 0.0,
                    0.005360730760296084, 0.0, 0.03639191270279407, 0.02509573640968621, 0.001736966111577587, 1.3766765505351941e-14 },
            { 0.9128553367958441, 0.498114343928149, 0.06854670075541414, 0.15666550320939443, 0.4462881127402396, 0.0013692098237374495, 0.5665980938774062, 0.8144153236957845, 0.0005113151690325779,
                    0.1416420561555476, 0.005608088104749331, 0.03924387870785795, 0.7446865656533612, 0.0288207714318085, 0.8400992196691042, 0.4175823709772777, 0.003078320501143761, 1.0,
                    0.022903954451297892, 0.7772462234060167, 0.005473816373038343, 0.16892616380333547, 0.3667572018404355, 0.42041967304830097, 0.09540778278756079 },
            { 0.0021335019339503436, 1.876419933255491e-05, 0.4532003763388206, 0.12283251689947461, 0.0006711761536843941, 0.0, 0.000909467025424604, 0.0036665924441832143, 0.0, 0.5905048269806548,
                    0.0, 0.6780122519144749, 0.004794310652375344, 0.7875890995355441, 0.010509196933885523, 0.12252179552985676, 0.0, 0.022903954451297892, 1.0, 0.005381160118725026,
                    0.38006243142058294, 3.14476073182135e-07, 0.00011481330253926281, 7.878973532049471e-06, 0.30469917638085375 },
            { 0.6443259005749744, 0.7136757365000084, 0.02143217336202774, 0.05979800460727058, 0.618450650260904, 0.002341877191370134, 0.7695718424282729, 0.5518680514542944, 0.0008446461634001867,
                    0.06766589101132836, 0.009853710668938476, 0.010318669887999565, 0.9635952691337171, 0.006768436339636086, 0.5926656132168697, 0.24759845267889768, 0.005360730760296084,
                    0.7772462234060167, 0.005381160118725026, 1.0, 0.0009261871498762453, 0.26717227899127294, 0.5272781306313865, 0.6153661582297021, 0.032392091417803304 },
            { 0.00016090191189466196, 6.801079066587334e-07, 0.10813801824129099, 0.015085669860296136, 8.754340507421965e-05, 0.0, 0.00010875399829579635, 0.0002993353151485856, 0.0,
                    0.27063095810327553, 0.0, 0.18836308423586168, 0.0008221944241708634, 0.22381198228808596, 0.0014586656940163145, 0.032698188561780306, 0.0, 0.005473816373038343,
                    0.38006243142058294, 0.0009261871498762453, 1.0, 8.646999338779437e-09, 9.808099303176832e-06, 2.572523558619366e-07, 0.059215335418212556 },
            { 0.04826936192406017, 0.3361521538090364, 7.2970293003571385e-06, 5.260447462585027e-05, 0.5936797284449291, 0.014540182902510468, 0.4113194879928441, 0.03174085377113545,
                    0.004300801276611255, 0.0011783967730545353, 0.06941197103759311, 9.635875533042793e-07, 0.29355485837660256, 2.3201192633770518e-07, 0.05640968517976419, 0.010749096237534062,
                    0.03639191270279407, 0.16892616380333547, 3.14476073182135e-07, 0.26717227899127294, 8.646999338779437e-09, 1.0, 0.6518609981112706, 0.4279229363509982, 1.7165548422015675e-05 },
            { 0.20736414310740714, 0.7109956591278599, 0.0008784788425570955, 0.0037104279017825537, 0.915805384818495, 0.01141553889749014, 0.7286622086504158, 0.15915693492736138,
                    0.004284623361268336, 0.01011106459969957, 0.044229573135349476, 0.00027318535576537073, 0.5613415185367734, 0.00013176608043852234, 0.2019174007758664, 0.057600374448060876,
                    0.02509573640968621, 0.3667572018404355, 0.00011481330253926281, 0.5272781306313865, 9.808099303176832e-06, 0.6518609981112706, 1.0, 0.8230487530584529, 0.001588339924907256 },
            { 0.21574056209118986, 0.860455359505405, 0.00014176902571128025, 0.0009083413431145715, 0.9300651912071818, 0.00048479010798008204, 0.8601541952387919, 0.15729692377242777,
                    7.808955319377198e-05, 0.007274902568656039, 0.004390909251123176, 2.3493472470326182e-05, 0.6560469395135131, 6.6745135760548635e-06, 0.21535406142524272, 0.05235214588576542,
                    0.001736966111577587, 0.42041967304830097, 7.878973532049471e-06, 0.6153661582297021, 2.572523558619366e-07, 0.4279229363509982, 0.8230487530584529, 1.0, 0.000312675888899383 },
            { 0.027512080784199977, 0.0006425929757265525, 0.7898514863190971, 0.6361547542313641, 0.00576010207415778, 8.881784197001252e-16, 0.008337911654616281, 0.0422248681648516, 0.0,
                    0.8971854870523459, 1.1302070390684094e-13, 0.5183918860527874, 0.02913999571445358, 0.39952957926571564, 0.0722220856911091, 0.40411394948128887, 1.3766765505351941e-14,
                    0.09540778278756079, 0.30469917638085375, 0.032392091417803304, 0.059215335418212556, 1.7165548422015675e-05, 0.001588339924907256, 0.000312675888899383, 1.0 },
    };

    // test constants
    double EQUALITY_DELTA = 1e-6;
    double ALPHA = .05;

    // check meanshift scores for all column pairings
    @Test
    void testTTestOneColumn() {
        for (int i = 0; i < nReferenceCols; i++) {
            for (int j = 0; j < nReferenceCols; j++) {
                Dataframe df1 = PregeneratedNormalData.generate(i);
                Dataframe df2 = PregeneratedNormalData.generate(j);
                Meanshift ms = new Meanshift(df1);
                Map<String, MeanshiftResult> msResults = ms.calculate(df2, ALPHA);

                assertEquals(pvalTable[i][j], msResults.get("0").getpValue(), EQUALITY_DELTA);
                assertEquals(tstatTable[i][j], msResults.get("0").gettStat(), EQUALITY_DELTA);
                assertEquals(pvalTable[i][j] <= ALPHA, msResults.get("0").isReject());
            }
        }
    }

    // check that meanshift scores are correct in multi-column cases
    void nColumnCase(boolean withText, boolean precompute) {
        Random rn = new Random(0);
        int ncols = 100;
        Integer[] idx1 = new Integer[ncols];
        Integer[] idx2 = new Integer[ncols];

        // generate two dataframes, consisting of a random ordering of columns drawn from cols
        for (int i = 0; i < ncols; i++) {
            idx1[i] = rn.nextInt(nReferenceCols);
            idx2[i] = rn.nextInt(nReferenceCols);
        }

        Dataframe df1 = PregeneratedNormalData.generate(idx1, withText);
        Dataframe df2 = PregeneratedNormalData.generate(idx2, withText);
        List<String> df1Names = df1.getColumnNames();
        List<String> df2Names = df2.getColumnNames();

        Meanshift ms;
        if (precompute) {
            PerColumnStatistics msf = Meanshift.precompute(df1);
            ms = new Meanshift(msf);
        } else {
            ms = new Meanshift(df1);
        }

        Map<String, MeanshiftResult> msResults = ms.calculate(df2, ALPHA);
        for (Map.Entry<String, MeanshiftResult> entry : msResults.entrySet()) {
            int i = df1Names.indexOf(entry.getKey());
            int refRow = idx1[i];
            int refCol = idx2[i];

            assertEquals(tstatTable[refRow][refCol], msResults.get(entry.getKey()).gettStat(), EQUALITY_DELTA);
            assertEquals(pvalTable[refRow][refCol], msResults.get(entry.getKey()).getpValue(), EQUALITY_DELTA);
            assertEquals(pvalTable[refRow][refCol] <= ALPHA, msResults.get(entry.getKey()).isReject());
        }
    }

    @Test
    void testTTestNColumn() {
        nColumnCase(false, false);
    }

    @Test
    void testTTestNColumnPrecomputed() {
        nColumnCase(false, true);
    }

    @Test
    void testNonNumericColumn() {
        nColumnCase(true, false);
    }

    @Test
    void testMismatchingColumns() {
        Random rn = new Random(0);
        int ncols = 100;
        Integer[] idx1 = new Integer[ncols];
        Integer[] idx2 = new Integer[ncols];

        // generate two dataframes, consisting of a random ordering of columns drawn from cols
        for (int i = 0; i < ncols; i++) {
            idx1[i] = rn.nextInt(nReferenceCols);
            idx2[i] = rn.nextInt(nReferenceCols);
        }

        Dataframe df1 = PregeneratedNormalData.generate(idx1, false);
        Dataframe df2 = PregeneratedNormalData.generate(idx2, false, "mismatch");

        Meanshift ms = new Meanshift(df1);
        assertThrows(IllegalArgumentException.class, () -> ms.calculate(df2, ALPHA));
    }

}
